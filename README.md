# ST3215-Stick-Dualbutton

M5StampS3 + M5Unit-Joystick2 で STS3215 サーボモーター 3 台と PWM サーボを制御するプロジェクト。

## 概要

- サーボ 1: マルチターン位置制御（ジョイスティック X 軸）
- サーボ 2: 連続回転制御（ジョイスティック Y 軸）
- サーボ 3: 位置制御（起動時原点復帰 + ジョイスティックボタンでシーケンス実行）
- PWM サーボ: 2 ボタンで角度切り替え
- X/Y 軸の同時操作防止

## ハードウェア構成

### マイコン

- **M5StampS3** (ESP32-S3)

### サーボモーター

- **Feetech STS3215** x 3 台
  - ID 1: マルチターン位置制御（Mode 3）
  - ID 2: ホイールモード（連続回転）
  - ID 3: マルチターン位置制御（Mode 3、起動時原点復帰）
  - TTL シリアル通信（半二重）1Mbps

- **PWM サーボ** x 1 台
  - 標準的な RC サーボ（50Hz PWM）

### 入力デバイス

- **M5Unit-Joystick2** (I2C: 0x63)
- **ボタン** x 2（プルアップ、押下で LOW）

### ピン配置

| 機能 | GPIO |
|------|------|
| STS3215 TX | 15 |
| STS3215 RX | 13 |
| I2C SDA (Joystick) | 2 |
| I2C SCL (Joystick) | 1 |
| PWM サーボ | 10 |
| ボタン 3 | 3 |
| ボタン 4 | 4 |

## 動作仕様

### サーボ 1（X 軸制御）

マルチターン位置制御モード。ジョイスティックの傾きに応じて動作が変化。

| 操作 | 動作 |
|------|------|
| 最大まで倒す | 3000 ステップ移動（デバウンス 3 回） |
| 中間位置で 1 秒保持 | 100 ステップずつ低速移動 |

- 移動速度: 最大 1500、低速 300
- ボタン押下中は操作無効

#### 原点設定と移動制限

両ボタンを 3 秒間長押しすると、現在位置を原点として設定。

| 方向 | 制限 |
|------|------|
| + 方向 | 原点から +100 ステップ |
| - 方向 | 原点から -33100 ステップ |

### サーボ 2（Y 軸制御）

ホイールモード（連続回転）。ジョイスティックの傾きに応じて速度変化。

- 最大速度: 1000
- デッドゾーン: ±3000（16bit ADC）
- X 軸が中央付近（±12000 以内）の時のみ有効

### サーボ 3（ジョイスティックボタン）

起動時に自動で原点復帰を実行。

#### 原点復帰シーケンス

1. 逆回転開始（速度 500）
2. 負荷検出で停止
3. 正回転 1 秒
4. 現在位置を原点として設定

#### ボタン押下シーケンス

ジョイスティックボタン押下で以下を実行：

1. 目標位置（34500 ステップ）まで移動
2. 2 秒待機
3. 原点まで戻る

移動完了は負荷監視で検出。

### PWM サーボ（ボタン制御）

| ボタン | 角度 |
|--------|------|
| なし | 87° |
| ボタン 3 のみ | 45° |
| ボタン 4 のみ | 135° |
| 両方 | 87°（原点設定モード） |

### X/Y 軸の排他制御

- Y 軸操作中は X 軸操作を無効化
- ジョイスティックが完全に中央に戻ると解除

## 使用ライブラリ

- [FTServo](https://github.com/ftservo/FTServo_Arduino) - Feetech バスサーボライブラリ
- [M5Unit-Joystick2](https://github.com/m5stack/M5Unit-Joystick2) - M5Stack ジョイスティックユニット

## ビルド・書き込み

```bash
# ビルド
pio run

# 書き込み
pio run --target upload

# シリアルモニタ
pio device monitor

# ビルド＆書き込み＆モニタ
pio run --target upload && pio device monitor
```
